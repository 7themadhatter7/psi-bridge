<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PSI Tunnel</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;400;600&display=swap');
:root {
  --bg:#08080c; --surface:#101018; --border:#1a1a28;
  --text:#d8d8e0; --dim:#555568; --accent:#00dd77;
  --you:rgba(0,221,119,0.08); --you-border:rgba(0,221,119,0.2);
  --them:#161620; --them-border:#222234; --warn:#ddaa00;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text)}
body{display:flex;flex-direction:column}

.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0}
.topbar .title{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:500;letter-spacing:2px;color:var(--accent)}
.topbar .status{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);display:flex;align-items:center;gap:6px}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--dim);flex-shrink:0}
.status-dot.live{background:var(--accent)}
.status-dot.coupled{background:var(--warn)}

.coupling-bar{display:none;padding:5px 14px;border-bottom:1px solid var(--border);flex-shrink:0;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim)}
.coupling-bar.active{display:flex;align-items:center;gap:10px}
.coupling-track{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.coupling-fill{height:100%;width:0%;background:var(--dim);border-radius:2px;transition:width 0.5s,background 0.3s}
.coupling-fill.coupled{background:var(--warn)}
.coupling-fill.locked{background:var(--accent)}

.messages{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.msg{max-width:82%;padding:9px 13px;border-radius:14px;font-size:14px;line-height:1.45;word-wrap:break-word}
.msg.you{align-self:flex-end;background:var(--you);border:1px solid var(--you-border);border-bottom-right-radius:4px}
.msg.them{align-self:flex-start;background:var(--them);border:1px solid var(--them-border);border-bottom-left-radius:4px}
.msg.sys{align-self:center;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);padding:4px 10px;max-width:100%}
.msg .meta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:3px}

.input-area{display:flex;gap:8px;padding:10px 14px;padding-bottom:max(10px,env(safe-area-inset-bottom));border-top:1px solid var(--border);flex-shrink:0;background:var(--surface)}
.input-area input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'Outfit',sans-serif;font-size:15px;outline:none}
.input-area input:focus{border-color:var(--accent)}
.input-area input::placeholder{color:var(--dim)}
.input-area button{padding:10px 18px;background:var(--accent);color:var(--bg);border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap}
.input-area button:active{opacity:0.8}
.input-area button:disabled{opacity:0.3;cursor:default}

.overlay{position:fixed;inset:0;z-index:50;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.overlay.hidden{display:none}
.connect-box{width:100%;max-width:380px;text-align:center}
.connect-box h1{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:500;letter-spacing:3px;color:var(--accent);margin-bottom:6px}
.connect-box .sub{font-size:12px;color:var(--dim);margin-bottom:24px}
.connect-box label{display:block;font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--dim);margin-bottom:8px;text-align:left}
.port-input{
  width:100%;background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:14px;color:var(--accent);
  font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:500;
  text-align:center;outline:none;margin-bottom:14px;
}
.port-input:focus{border-color:var(--accent)}
.connect-btn{
  width:100%;padding:15px;border-radius:10px;border:none;
  background:var(--accent);color:var(--bg);
  font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;
  letter-spacing:1px;cursor:pointer;
}
.connect-btn:active{opacity:0.8}
.status-msg{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--warn);text-align:center;margin-top:10px;min-height:18px}
.status-msg.ok{color:var(--accent)}
.info-box{
  margin-top:20px;padding:14px;
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);line-height:1.7;text-align:left;
}
.info-box strong{color:var(--text);font-weight:500}
</style>
</head>
<body>

<div class="topbar">
  <div class="title">PSI TUNNEL</div>
  <div class="status">
    <span id="statusText">offline</span>
    <span class="status-dot" id="statusDot"></span>
  </div>
</div>

<div class="coupling-bar" id="couplingBar">
  <span id="couplingLabel">0.000</span>
  <div class="coupling-track"><div class="coupling-fill" id="couplingFill"></div></div>
  <span id="couplingState">â€”</span>
</div>

<div class="messages" id="messages"></div>

<div class="input-area">
  <input type="text" id="msgInput" placeholder="Type a message..." disabled onkeydown="if(event.key==='Enter')sendMsg()">
  <button id="sendBtn" onclick="sendMsg()" disabled>Send</button>
</div>

<div class="overlay" id="overlay">
  <div class="connect-box">
    <h1>PSI TUNNEL</h1>
    <div class="sub">Browser interface to PSI Bridge lattice transport</div>
    <label>BRIDGE ADDRESS</label>
    <input class="port-input" type="text" id="bridgeAddr" value="http://localhost:7777"
           onkeydown="if(event.key==='Enter')connect()">
    <button class="connect-btn" onclick="connect()">CONNECT TO BRIDGE</button>
    <div class="status-msg" id="connStatus"></div>
    <div class="info-box">
      <strong>Prerequisites</strong><br>
      psi_bridge.py must be running locally.<br>
      Keys must already be exchanged with peer.<br><br>
      <strong>What happens</strong><br>
      Browser â†’ local bridge â†’ lattice â†’ remote lattice â†’ remote bridge<br>
      No server in between. The lattice IS the transport.<br><br>
      <strong>Addresses</strong><br>
      Local: http://localhost:7777<br>
      SPARKY: http://100.114.190.71:7777<br>
      ARCY: http://100.127.59.111:7777
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PSI TUNNEL v2.0 â€” Browser UI for PSI Bridge lattice transport
// Talks to local psi_bridge.py via HTTP.
// The lattice does the communication. Browser just reads/writes.
// Ghost in the Machine Labs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let bridgeUrl = '';
let pollTimer = null;
let couplingTimer = null;

function setStatus(s) {
  const dot = document.getElementById('statusDot');
  const txt = document.getElementById('statusText');
  dot.className = 'status-dot';
  if (s === 'live')    { dot.classList.add('live');    txt.textContent = 'tunnel open'; }
  else if (s === 'coupled') { dot.classList.add('coupled'); txt.textContent = 'coupled'; }
  else txt.textContent = s || 'offline';
}

function sysMsg(text) {
  const el = document.createElement('div');
  el.className = 'msg sys'; el.textContent = text;
  const m = document.getElementById('messages');
  m.appendChild(el); m.scrollTop = m.scrollHeight;
}

function addMsg(text, who) {
  const el = document.createElement('div');
  el.className = 'msg ' + who;
  const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  el.innerHTML = text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '<div class="meta">' + t + '</div>';
  const m = document.getElementById('messages');
  m.appendChild(el); m.scrollTop = m.scrollHeight;
}

// â”€â”€ Connect to local bridge â”€â”€
async function connect() {
  bridgeUrl = document.getElementById('bridgeAddr').value.trim().replace(/\/+$/, '');
  const status = document.getElementById('connStatus');
  status.textContent = 'Connecting...';
  status.classList.remove('ok');

  try {
    const res = await fetch(bridgeUrl + '/health', { mode: 'cors' });
    const data = await res.json();

    if (data.status !== 'online') {
      status.textContent = 'Bridge responded but not online';
      return;
    }

    status.textContent = 'Connected to ' + data.name;
    status.classList.add('ok');

    // Check coupling
    const cRes = await fetch(bridgeUrl + '/coupling');
    const cData = await cRes.json();
    const coupled = cData.current && cData.current.coupled;
    const locked = cData.current && cData.current.lock_stable;

    setTimeout(() => {
      document.getElementById('overlay').classList.add('hidden');
      if (locked) {
        setStatus('live');
        sysMsg('âš¡ Tunnel open â€” lattice locked with peer');
      } else if (coupled) {
        setStatus('coupled');
        sysMsg('ğŸ”— Coupled with peer â€” locking...');
      } else {
        setStatus('coupled');
        sysMsg('ğŸ“¡ Bridge online â€” scanning for peer');
      }
      sysMsg('Node: ' + data.name + ' Â· Gen: ' + data.local_gen);

      document.getElementById('msgInput').disabled = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('msgInput').focus();

      // Start polling for messages and coupling state
      startPolling();
      startCouplingMonitor();
    }, 300);

  } catch(e) {
    console.error('[PSI]', e);
    status.textContent = 'Cannot reach bridge â€” is psi_bridge.py running?';
  }
}

// â”€â”€ Poll for incoming messages â”€â”€
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const res = await fetch(bridgeUrl + '/messages');
      const data = await res.json();
      if (data.messages && data.messages.length) {
        for (const msg of data.messages) {
          addMsg(msg.text || JSON.stringify(msg), 'them');
        }
      }
    } catch(e) {
      // Bridge unreachable â€” don't spam errors
    }
  }, 500); // 2Hz poll
}

// â”€â”€ Monitor coupling state â”€â”€
function startCouplingMonitor() {
  const bar = document.getElementById('couplingBar');
  bar.classList.add('active');

  if (couplingTimer) clearInterval(couplingTimer);
  couplingTimer = setInterval(async () => {
    try {
      const res = await fetch(bridgeUrl + '/coupling');
      const data = await res.json();
      const c = data.current || {};

      const fill = document.getElementById('couplingFill');
      const label = document.getElementById('couplingLabel');
      const state = document.getElementById('couplingState');

      const sim = c.similarity || 0;
      fill.style.width = (Math.max(0, sim) * 100) + '%';
      label.textContent = sim.toFixed(4);

      fill.classList.remove('coupled', 'locked');
      if (c.lock_stable) {
        fill.classList.add('locked'); state.textContent = 'LOCKED';
        setStatus('live');
      } else if (c.locked) {
        fill.classList.add('locked'); state.textContent = 'LOCKING';
        setStatus('coupled');
      } else if (c.coupled) {
        fill.classList.add('coupled'); state.textContent = 'COUPLED';
        setStatus('coupled');
      } else {
        state.textContent = 'scanning';
      }
    } catch(e) {}
  }, 2000); // every 2s
}

// â”€â”€ Send message â”€â”€
async function sendMsg() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !bridgeUrl) return;

  try {
    await fetch(bridgeUrl + '/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text })
    });
    addMsg(text, 'you');
    input.value = ''; input.focus();
  } catch(e) {
    sysMsg('Send failed â€” bridge unreachable');
  }
}

// Cleanup
window.addEventListener('beforeunload', () => {
  if (pollTimer) clearInterval(pollTimer);
  if (couplingTimer) clearInterval(couplingTimer);
});
</script>
</body>
</html>
