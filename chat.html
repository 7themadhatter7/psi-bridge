<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PSI Bridge</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0a;color:#e0e0e0;font-family:'Courier New',monospace;height:100vh;display:flex;flex-direction:column}
#header{padding:12px 16px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
#header h1{font-size:14px;color:#00ff88}
#status{font-size:12px;padding:4px 10px;border-radius:10px;background:#222}
#status.bootstrap{color:#ff8800}
#status.http{color:#00aaff}
#status.substrate{color:#00ff88}
#messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
.msg{padding:8px 12px;border-radius:6px;max-width:80%;font-size:13px;line-height:1.4}
.msg.you{background:#003322;align-self:flex-end;color:#00ff88}
.msg.them{background:#1a1a2e;align-self:flex-start;color:#7788ff}
.msg.sys{background:transparent;align-self:center;color:#555;font-size:11px}
#input-bar{padding:12px 16px;border-top:1px solid #222;display:flex;gap:8px}
#msgInput{flex:1;background:#111;border:1px solid #333;color:#e0e0e0;padding:10px;border-radius:6px;font-family:inherit;font-size:13px}
#msgInput:focus{outline:none;border-color:#00ff88}
button{background:#00ff88;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-family:inherit;font-weight:bold}
button:hover{background:#00cc66}
#coupling-bar{height:3px;background:#111}
#coupling-fill{height:100%;background:#00ff88;width:0%;transition:width 0.5s}
</style>
</head>
<body>
<div id="header">
  <h1>âš¡ PSI BRIDGE</h1>
  <span id="status" class="bootstrap">connecting...</span>
</div>
<div id="coupling-bar"><div id="coupling-fill"></div></div>
<div id="messages"></div>
<div id="input-bar">
  <input id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMsg()">
  <button onclick="sendMsg()">SEND</button>
</div>
<script>
const B='http://localhost:7777';
let pollT,coupT;

function addMsg(text,type){
  const d=document.getElementById('messages');
  const m=document.createElement('div');
  m.className='msg '+type;
  m.textContent=text;
  d.appendChild(m);
  d.scrollTop=d.scrollHeight;
}

function setStatus(mode){
  const s=document.getElementById('status');
  s.className='';
  s.classList.add(mode);
  s.textContent=mode==='substrate'?'ðŸ”’ SUBSTRATE':mode==='http'?'ðŸ“¡ HTTP':mode==='bootstrap'?'â³ BOOTSTRAP':'offline';
}

async function init(){
  try{
    const r=await fetch(B+'/status');
    const d=await r.json();
    setStatus(d.transport||'bootstrap');
    addMsg('Connected to bridge','sys');
    if(d.substrate_ready) addMsg('Substrate transport active â€” channel invisible','sys');
    else if(d.lock_stable) addMsg('Lock stable â€” substrate initializing...','sys');
    startPolling();startCoupling();
  }catch(e){
    setStatus('offline');
    addMsg('Waiting for bridge on localhost:7777...','sys');
    setTimeout(init,3000);
  }
}

function startPolling(){
  if(pollT)clearInterval(pollT);
  pollT=setInterval(async()=>{
    try{
      const r=await fetch(B+'/messages');const d=await r.json();
      if(d.messages)for(const m of d.messages)addMsg(m.text||JSON.stringify(m),'them');
    }catch(e){}
  },500);
}

function startCoupling(){
  if(coupT)clearInterval(coupT);
  coupT=setInterval(async()=>{
    try{
      const r=await fetch(B+'/status');const d=await r.json();
      const fill=document.getElementById('coupling-fill');
      setStatus(d.transport||'bootstrap');
      if(d.lock_stable)fill.style.width='100%';
      else fill.style.width='0%';
    }catch(e){}
  },2000);
}

async function sendMsg(){
  const input=document.getElementById('msgInput');
  const text=input.value.trim();
  if(!text)return;
  try{
    await fetch(B+'/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    addMsg(text,'you');input.value='';input.focus();
  }catch(e){addMsg('Send failed â€” bridge unreachable','sys');}
}

init();
</script>
</body>
</html>
